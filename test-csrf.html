<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø§Ø®ØªØ¨Ø§Ø± CSRF - CSRF Test</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 800px;
      width: 100%;
      padding: 40px;
    }
    
    h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 10px;
      font-size: 2.5em;
    }
    
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 1.1em;
    }
    
    .test-section {
      margin-bottom: 30px;
    }
    
    .test-section h2 {
      color: #444;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .test-section h2::before {
      content: "ğŸ§ª";
      font-size: 1.5em;
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 1.1em;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      width: 100%;
      margin-bottom: 15px;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .result {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-top: 15px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 400px;
      overflow-y: auto;
      border: 2px solid #e9ecef;
    }
    
    .result:empty {
      display: none;
    }
    
    .success {
      color: #28a745;
      font-weight: bold;
    }
    
    .error {
      color: #dc3545;
      font-weight: bold;
    }
    
    .info {
      color: #17a2b8;
    }
    
    .warning {
      color: #ffc107;
    }
    
    .status-badge {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9em;
      margin-left: 10px;
    }
    
    .status-ok {
      background: #d4edda;
      color: #155724;
    }
    
    .status-error {
      background: #f8d7da;
      color: #721c24;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 5px;
      color: #555;
      font-weight: 500;
    }
    
    .input-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 1em;
      transition: border-color 0.3s;
    }
    
    .input-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .footer {
      text-align: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid #e9ecef;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” Ø§Ø®ØªØ¨Ø§Ø± CSRF</h1>
    <p class="subtitle">CSRF Protection Test Page</p>
    
    <!-- Test 1: Diagnostic -->
    <div class="test-section">
      <h2>ÙØ­Øµ Ø§Ù„ØªÙƒÙˆÙŠÙ†</h2>
      <button onclick="testDiagnostic()">ğŸ” ÙØ­Øµ ØªÙƒÙˆÙŠÙ† CSRF</button>
      <div id="diagnostic-result" class="result"></div>
    </div>
    
    <!-- Test 2: Get Token -->
    <div class="test-section">
      <h2>Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Token</h2>
      <button onclick="getToken()">ğŸ« Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Token</button>
      <div id="token-result" class="result"></div>
    </div>
    
    <!-- Test 3: Test Token -->
    <div class="test-section">
      <h2>Ø§Ø®ØªØ¨Ø§Ø± Token</h2>
      <button onclick="testToken()" id="test-token-btn" disabled>âœ… Ø§Ø®ØªØ¨Ø± Token (Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ token Ø£ÙˆÙ„Ø§Ù‹)</button>
      <div id="test-result" class="result"></div>
    </div>
    
    <!-- Test 4: Login -->
    <div class="test-section">
      <h2>Ø§Ø®ØªØ¨Ø§Ø± Login</h2>
      <div class="input-group">
        <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ / Email:</label>
        <input type="email" id="email" value="test@example.com" placeholder="test@example.com">
      </div>
      <div class="input-group">
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± / Password:</label>
        <input type="password" id="password" value="password123" placeholder="password123">
      </div>
      <button onclick="testLogin()" id="login-btn" disabled>ğŸ”‘ Ø§Ø®ØªØ¨Ø± Login (Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ token Ø£ÙˆÙ„Ø§Ù‹)</button>
      <div id="login-result" class="result"></div>
    </div>
    
    <!-- Test 5: Full Flow -->
    <div class="test-section">
      <h2>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„</h2>
      <button onclick="testFullFlow()">ğŸš€ Ø§Ø®ØªØ¨Ø§Ø± ÙƒØ§Ù…Ù„ (Token + Login)</button>
      <div id="full-flow-result" class="result"></div>
    </div>
    
    <div class="footer">
      <p>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Backend Ø¹Ù„Ù‰ <strong>http://localhost:4000</strong></p>
      <p>ğŸ”§ Ù„ØªØºÙŠÙŠØ± URLØŒ Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…ØªØºÙŠØ± <code>API_URL</code> ÙÙŠ Ø§Ù„ÙƒÙˆØ¯</p>
    </div>
  </div>

  <script>
    // Configuration
    const API_URL = 'http://localhost:4000';
    let csrfToken = null;

    // Helper functions
    function log(elementId, message, type = 'info') {
      const el = document.getElementById(elementId);
      const timestamp = new Date().toLocaleTimeString('ar-EG');
      const icon = {
        success: 'âœ…',
        error: 'âŒ',
        info: 'â„¹ï¸',
        warning: 'âš ï¸'
      }[type] || 'â„¹ï¸';
      
      el.innerHTML += `[${timestamp}] ${icon} ${message}\n`;
      el.scrollTop = el.scrollHeight;
    }

    function clear(elementId) {
      document.getElementById(elementId).innerHTML = '';
    }

    // Test 1: Diagnostic
    async function testDiagnostic() {
      clear('diagnostic-result');
      log('diagnostic-result', 'Ø¬Ø§Ø±ÙŠ ÙØ­Øµ ØªÙƒÙˆÙŠÙ† CSRF...', 'info');
      
      try {
        const response = await fetch(`${API_URL}/api/v1/auth/csrf-diagnostic`);
        const data = await response.json();
        
        log('diagnostic-result', `Ø§Ù„Ø­Ø§Ù„Ø©: ${data.status}`, data.status === 'OK' ? 'success' : 'error');
        log('diagnostic-result', `CSRF Secret Ù…ÙˆØ¬ÙˆØ¯: ${data.csrf.secretConfigured ? 'âœ“' : 'âœ—'}`, data.csrf.secretConfigured ? 'success' : 'error');
        log('diagnostic-result', `Token ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡: ${data.csrf.tokenGenerated ? 'âœ“' : 'âœ—'}`, data.csrf.tokenGenerated ? 'success' : 'error');
        log('diagnostic-result', `Ø§Ù„Ø¨ÙŠØ¦Ø©: ${data.environment.nodeEnv}`, 'info');
        
        if (data.recommendations && data.recommendations.length > 0) {
          log('diagnostic-result', '\nØ§Ù„ØªÙˆØµÙŠØ§Øª:', 'warning');
          data.recommendations.forEach(rec => {
            const type = rec.severity === 'SUCCESS' ? 'success' : 
                        rec.severity === 'CRITICAL' ? 'error' : 'warning';
            log('diagnostic-result', `- ${rec.arabic || rec.issue}`, type);
          });
        }
        
        log('diagnostic-result', '\n' + JSON.stringify(data, null, 2), 'info');
      } catch (error) {
        log('diagnostic-result', `Ø®Ø·Ø£: ${error.message}`, 'error');
      }
    }

    // Test 2: Get Token
    async function getToken() {
      clear('token-result');
      log('token-result', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ CSRF Token...', 'info');
      
      try {
        const response = await fetch(`${API_URL}/api/v1/auth/csrf-token`, {
          credentials: 'include'
        });
        const data = await response.json();
        
        csrfToken = data.token || data.data?.token;
        
        if (csrfToken) {
          log('token-result', 'ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Token Ø¨Ù†Ø¬Ø§Ø­! âœ“', 'success');
          log('token-result', `Token: ${csrfToken.substring(0, 50)}...`, 'info');
          log('token-result', `Ø§Ù„Ø·ÙˆÙ„: ${csrfToken.length} Ø­Ø±Ù`, 'info');
          log('token-result', `ØµØ§Ù„Ø­ Ù„Ù…Ø¯Ø©: ${data.data?.expiresIn / 1000 / 60} Ø¯Ù‚ÙŠÙ‚Ø©`, 'info');
          
          // Enable test buttons
          document.getElementById('test-token-btn').disabled = false;
          document.getElementById('login-btn').disabled = false;
          document.getElementById('test-token-btn').textContent = 'âœ… Ø§Ø®ØªØ¨Ø± Token';
          document.getElementById('login-btn').textContent = 'ğŸ”‘ Ø§Ø®ØªØ¨Ø± Login';
        } else {
          log('token-result', 'ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Token!', 'error');
        }
      } catch (error) {
        log('token-result', `Ø®Ø·Ø£: ${error.message}`, 'error');
      }
    }

    // Test 3: Test Token
    async function testToken() {
      if (!csrfToken) {
        alert('Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Token Ø£ÙˆÙ„Ø§Ù‹!');
        return;
      }
      
      clear('test-result');
      log('test-result', 'Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± ØµØ­Ø© Token...', 'info');
      
      try {
        const response = await fetch(`${API_URL}/api/v1/auth/csrf-test`, {
          method: 'POST',
          credentials: 'include',
          headers: {
            'X-CSRF-Token': csrfToken
          }
        });
        const data = await response.json();
        
        if (data.success) {
          log('test-result', 'Token ØµØ§Ù„Ø­! âœ“', 'success');
        } else {
          log('test-result', 'Token ØºÙŠØ± ØµØ§Ù„Ø­!', 'error');
        }
        
        log('test-result', `Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ${data.messageAr || data.message}`, 'info');
        log('test-result', '\n' + JSON.stringify(data, null, 2), 'info');
      } catch (error) {
        log('test-result', `Ø®Ø·Ø£: ${error.message}`, 'error');
      }
    }

    // Test 4: Login
    async function testLogin() {
      if (!csrfToken) {
        alert('Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Token Ø£ÙˆÙ„Ø§Ù‹!');
        return;
      }
      
      clear('login-result');
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      log('login-result', 'Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Login...', 'info');
      log('login-result', `Email: ${email}`, 'info');
      log('login-result', `Password: ${password}`, 'info');
      
      try {
        const response = await fetch(`${API_URL}/api/v1/auth/login`, {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrfToken
          },
          body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        
        log('login-result', `Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©: ${response.status}`, 'info');
        
        if (response.status === 200) {
          log('login-result', 'Login Ù†Ø¬Ø­! âœ“', 'success');
          log('login-result', 'CSRF ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­! âœ“âœ“âœ“', 'success');
        } else if (response.status === 401) {
          log('login-result', 'Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø®ÙˆÙ„ Ø®Ø§Ø·Ø¦Ø© (Ù„ÙƒÙ† CSRF ÙŠØ¹Ù…Ù„!) âœ“', 'warning');
          log('login-result', 'CSRF ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­! âœ“âœ“âœ“', 'success');
        } else if (response.status === 403 && data.code?.includes('CSRF')) {
          log('login-result', 'CSRF ÙØ´Ù„!', 'error');
          log('login-result', `Ø§Ù„ÙƒÙˆØ¯: ${data.code}`, 'error');
        } else {
          log('login-result', `Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø©: ${response.status}`, 'warning');
        }
        
        log('login-result', `\nØ§Ù„Ø±Ø³Ø§Ù„Ø©: ${data.messageAr || data.message}`, 'info');
        log('login-result', '\n' + JSON.stringify(data, null, 2), 'info');
      } catch (error) {
        log('login-result', `Ø®Ø·Ø£: ${error.message}`, 'error');
      }
    }

    // Test 5: Full Flow
    async function testFullFlow() {
      clear('full-flow-result');
      log('full-flow-result', 'ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„...', 'info');
      log('full-flow-result', '='.repeat(50), 'info');
      
      // Step 1: Diagnostic
      log('full-flow-result', '\nğŸ“‹ Ø§Ù„Ø®Ø·ÙˆØ© 1: ÙØ­Øµ Ø§Ù„ØªÙƒÙˆÙŠÙ†', 'info');
      try {
        const diagResponse = await fetch(`${API_URL}/api/v1/auth/csrf-diagnostic`);
        const diagData = await diagResponse.json();
        log('full-flow-result', `âœ“ Ø§Ù„Ø­Ø§Ù„Ø©: ${diagData.status}`, diagData.status === 'OK' ? 'success' : 'error');
      } catch (error) {
        log('full-flow-result', `âœ— ÙØ´Ù„: ${error.message}`, 'error');
        return;
      }
      
      // Step 2: Get Token
      log('full-flow-result', '\nğŸ« Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Token', 'info');
      try {
        const tokenResponse = await fetch(`${API_URL}/api/v1/auth/csrf-token`, {
          credentials: 'include'
        });
        const tokenData = await tokenResponse.json();
        csrfToken = tokenData.token || tokenData.data?.token;
        
        if (csrfToken) {
          log('full-flow-result', `âœ“ ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Token`, 'success');
          log('full-flow-result', `  Token: ${csrfToken.substring(0, 30)}...`, 'info');
        } else {
          log('full-flow-result', `âœ— ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Token`, 'error');
          return;
        }
      } catch (error) {
        log('full-flow-result', `âœ— ÙØ´Ù„: ${error.message}`, 'error');
        return;
      }
      
      // Step 3: Test Login
      log('full-flow-result', '\nğŸ”‘ Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ø®ØªØ¨Ø§Ø± Login', 'info');
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      try {
        const loginResponse = await fetch(`${API_URL}/api/v1/auth/login`, {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrfToken
          },
          body: JSON.stringify({ email, password })
        });
        
        const loginData = await loginResponse.json();
        
        if (loginResponse.status === 200 || loginResponse.status === 401) {
          log('full-flow-result', 'âœ“ CSRF ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­!', 'success');
          log('full-flow-result', `  Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©: ${loginResponse.status}`, 'info');
        } else if (loginResponse.status === 403 && loginData.code?.includes('CSRF')) {
          log('full-flow-result', 'âœ— CSRF ÙØ´Ù„!', 'error');
          log('full-flow-result', `  Ø§Ù„ÙƒÙˆØ¯: ${loginData.code}`, 'error');
        }
      } catch (error) {
        log('full-flow-result', `âœ— ÙØ´Ù„: ${error.message}`, 'error');
        return;
      }
      
      // Summary
      log('full-flow-result', '\n' + '='.repeat(50), 'info');
      log('full-flow-result', 'ğŸ‰ Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„!', 'success');
      log('full-flow-result', 'âœ“ Ù†Ø¸Ø§Ù… CSRF ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­!', 'success');
    }

    // Auto-run diagnostic on load
    window.addEventListener('load', () => {
      setTimeout(testDiagnostic, 500);
    });
  </script>
</body>
</html>
